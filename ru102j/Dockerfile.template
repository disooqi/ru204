# redisuniversity/ru102j-lab
FROM redisuniversity/virtual-lab-ide:$REDIS_VERSION

ENV LD_LIBRARY_PATH /usr/lib/redis/modules/
ENV PATH="/usr/lib/jvm/java-1.8-openjdk/bin:${PATH}"

RUN set -ex && \
        apk add --no-cache \
                coreutils \
                g++ \
      linux-headers \
                make \
      openjdk8 \ 
      maven \
      emacs \
      git && \
      mkdir -p /usr/src/redistimeseries && \
      cd /usr/src/redistimeseries/ && \
      git clone https://github.com/RedisLabsModules/RedisTimeSeries.git && \
      cd RedisTimeSeries && \
      git submodule init && \
      git submodule update && \
      cd src && \
      make all && \
      mkdir -p /usr/lib/redis/modules && \
      cp redistimeseries.so /usr/lib/redis/modules && \
      mkdir /src/redisu/project

RUN set -ex && apk add --no-cache nss

# Supervisord config
ADD supervisord.conf /etc/

ADD .logo /home/student/.logo
ADD project /src/redisu/project
RUN chown -R student:student /src/redisu

RUN set -ex && \
    cd /src/redisu/project && \
    mvn compile

# Base rdb files
ADD ru102j.rdb /data/dump.rdb
RUN chown redis:redis /data/dump.rdb

# Port for web front end and API. This allows users to hit
# this port from the virtual lab
EXPOSE 6391
